# Análisis de redes

```{r}
#| label: librerias_redes

library(tidygraph)
library(ggraph)
library(stringr)
library(tidyverse)
library(here)
           
```

```{r}
#| label: inputs_redes

# Levanto el dataset de la encuesta
# Pongo "redes_tu_nombre"como primera columna

df_encuesta <- read_rds(here::here("Outputs", "df_encuesta.rds")) |>
               relocate(redes_tu_nombre)
```

## Insumo de la encuesta

El insumo de estos análisis es una serie de preguntas en donde cada estudiante debe elegir, entre todos los estudiantes de ese cuatrimestre, a los 5 a los que más conoce. Como tal este módulo puede considerarse como una serie de preguntas cerradas de respuesta única con la característica saliente de que esas preguntas poseen muchas opciones posibles. En efecto, las opciones son tantas como estudiantes estén cursando la materia. Desde un punto de vista metodológico lo importante no es tanto que las opciones sean muchas o pocas sino que el rango de estas es conocido y discreto.

Luego de una primera pregunta en donde el estudiante se auto identifica en la lista se pasa a otras 5 preguntas en donde el estudiante va eligiendo a otres compañeres a los cuales más conoce. Si no conoce a nadie más elige la opción "00-NO CONOZCO A NADIE MAS" en las siguientes preguntas.

<center>

![pregunta_redes_1](Inputs/Images/pregunta_redes_1.png){width="600"}

![pregunta_redes_2](Inputs/Images/pregunta_redes_2.png){width="600"}

</center>

La explicitación de lo anterior es importante por la siguiente razón. El análisis de redes sociales (SNA) no se suele llevar bien con la estructura de datos conocida conocida en las ciencias sociales como **matriz de datos** [@galtung1973] o, más en general, como una estructura de datos "casos x variables". Como lo suguiere esta última descripción esta es una estructura afín a lo que se suele demoninar "datos de atributos" en donde los valores de las variables se consideran atributos de cada uno de los casos. En cambio, en el SNA suele ser preferible alguna de los siguientes estructura de datos que se consideran más idóneas para representar un tipo de dato **relacional** [@scott2017, cap. 4]:

a\) Una **matriz de adyacencia** (*adjacency matrix*) en donde las filas y las columnas son asignados para los (mismos) nodos de la red y la presencia de una relación es representada con un valor numérico. Se dice que es una matriz cuadrada y dispersa porque tiene la misma cantidad de filas y columnas y puede que muchas de sus celdas contengan un valor "0". Se suele considerar la representación estándar de esta técnica.

b)  Una **lista de lazos** (e*dge list*) en donde (sólo) se "listan" todas las relaciones de la red. Es una opción que, en comparación a la opción "a", suele ocupar menos espacio en memoria ya que sólo representa la presencia y/o intensidad de las relaciones entre los nodos. En general se trata de una estructura más larga que ancha ya que cada relación ocupa una fila y las columnas se suelen limitar (aunque no necesariamente) a algo como "origen" (*from*), "destino" (*to*) e "intensidad de la relación".

c\) Una **lista de adyacencia** (*adjacency list*) que puede considerarse un híbrido entre las opciones "a" y "b". En este caso cada nodo se representan en una fila y cada una de ellas se "listan" todas sus relaciones con otros nodos. Dado lo anterior esta estructura tiene tantas filas como nodos pero la cantidad de columnas de cada fila es igual a la cantidad de relaciones que tenga cada nodo.

## Breve introducción al análisis de redes

```{r}
#| label: nodes

nodes <- df_encuesta

```

```{r}
#| label: edges

# Hay que realizar desde el archivo de la encuesta dos columnas (from, to) en donde
# el "from" sea el encuestado "redes_tu_nombre" y que 
# el "to" sea el estudiante a quien haya elegido. 
# Dado que cada encuestado elige a 5 estudiantes en este nuevo objeto debería
# haber 5 filas por encuestado.
# Luego de eso se debería filtrar "los edges" para que queden sólo aquellos que están presentes en el "nodes", esto es, con los que contestaron la encuesta.
# 
# Se podría agregar otras columnas al edge
#       cuanti_comision,
#                       unaj_ano_ingreso,
#                       unaj_n_materias_aprobadas,
#                       unaj_n_materias_aprobadas_10

edges <- df_encuesta |>
select(
mail,
redes_tu_nombre,
redes_1_contacto,
redes_2_contacto,
redes_3_contacto,
redes_4_contacto,
redes_5_contacto,
cuanti_docente,
unaj_ano_ingreso,
unaj_ano_lectivo,
unaj_periodo_lectivo_num,
unaj_n_materias_aprobadas,
unaj_n_materias_aprobadas_10) |>
pivot_longer(c(
redes_1_contacto,
redes_2_contacto,
redes_3_contacto,
redes_4_contacto,
redes_5_contacto),
names_to = "orden_del_contacto",
values_to = "to") |>
mutate(intensidad_relacion = as.integer(case_when(
orden_del_contacto == "redes_1_contacto" ~ "1",
orden_del_contacto == "redes_2_contacto" ~ "2",
orden_del_contacto == "redes_3_contacto" ~ "3",
orden_del_contacto == "redes_4_contacto" ~ "4",
orden_del_contacto == "redes_5_contacto" ~ "5"))) |>
select(!c(mail, orden_del_contacto)) |>
semi_join(nodes, by = c("to" = "redes_tu_nombre")) |>
rename(from = redes_tu_nombre) |>
relocate(to)
          
```

```{r}
#| label: net

# Creo la red con tidygraph

net <- tbl_graph(nodes = nodes,
                 node_key = "redes_tu_nombre",
                 edges = edges,
                 directed = TRUE)

# se puede agregar "directed = TRUE" pero algunas medidas de comunidad no se pueden calcular
```

El análisis de redes (*Network Analysis* o NA) es un enfoque que tiene una larga historia dentro de las ciencias en general.

En el caso más particular del [Análisis de Redes Sociales](https://es.wikipedia.org/wiki/An%C3%A1lisis_de_redes#An%C3%A1lisis_de_Redes_Sociales) (Social *Network Analysis* o SNA) su origen tiene 2 patas diferenciadas. Por un lado, tuvo que ver con la invención del [sociograma](https://es.wikipedia.org/wiki/Sociograma), el cual, a su turno, tuvo que ver con el origen de la [sociometría](https://es.wikipedia.org/wiki/Sociometr%C3%ADa). El sociograma es una herramienta de visualización de las relaciones sociales que conforman un grupo. Para su construcción se requiere de datos de todos los miembros de ese grupo por lo que su utilización muchas veces se restringue a grupos o organizaciones pequeños. En parte por lo anterior, no son muchas las investigaciones empíricas que lo utilizan dada la dificultad metodológica de obtener esos datos.

::: {.callout-note collapse="true"}
## Sabías qué? Análisis de redes y matemática

El análisis de redes en general y el análisis de redes sociales en particular puede considerarse como una aplicación de una teoría matemática abstracta como es la [teoría de grafos](https://es.wikipedia.org/wiki/Teor%C3%ADa_de_grafos) (*Graph Theory*). Esta última se origina en un [clásico artículo](https://drive.google.com/file/d/1Vr1BQT-7GAK9ia5YbMfYul4Lwzhv3LVP/view) de Leonard Euler de 1736 conocido como los [Los siete puentes de Königsberg](https://es.wikipedia.org/wiki/Problema_de_los_puentes_de_K%C3%B6nigsberg). El problema consistía en encontrar un recorrido para cruzar a pie toda la ciudad pasando sólo una vez por cada uno de los puentes y regresando al mismo punto de inicio.

![](_book/Inputs/Images/euler_article.png){fig-align="center"}
:::

Recién luego de varias décadas la visualización del sociograma se relacionó explícitamente con la teoría de grafos, dando origen al SNA. Si los sociogramas tenían la dificultad metodológica de su construcción, con la incorporación de la teoría de grafos se sumó la dificultad metodológica del análisis de esos datos. Estas 2 condiciones afectan mucho el grado de difusión de este enfoque. En parte por lo anterior, en lo que sigue se mostrará como se pueden hacer análisis y visualizaciones de redes con datos provenientes de una base original de casos x columnas.

## Análisis y visualizaciones

### Centralidades de los estudiantes y sus relaciones

En un grafo, los nodos (*nodes*) representan a los entes relacionados (aquí estudiantes) y las líneas (*edges*) representan a las relaciones entre ellos. En este caso primero vamos a calcular una medida de centralidad de los nodos en función de las relaciones que cada uno tiene y con quién. En este sentido, no es lo mismo conocer a 5 personas que son pocos conocidos que conocer a 5 personas que son muy conocidas por otros. En el casos de las relaciones vamos a calcular otra medida de centralidad basada en la idea de intermediación .[^redes-1]

```{r}
#| label: net_diego

# Se programa para siempre realizar el análisis sobre la última cursada

net_diego <- net |>
activate(nodes) |>
filter(cuanti_docente == "Diego Quartulli") |>
filter(unaj_ano_lectivo == max(unaj_ano_lectivo)) |>
filter(unaj_periodo_lectivo_num == max(unaj_periodo_lectivo_num)) |>
mutate(node_pagerank = centrality_pagerank(),
       node_centrality_betw = centrality_betweenness(),
       siglas = str_sub(redes_tu_nombre, start = 1L, end = 5L),
       node_comunidad = as.factor(group_components())) |>
activate(edges) |>
mutate(edge_centrality_betw = centrality_edge_betweenness())
```

```{r}
#| label: graph_diego
#| echo: false
#| output: true

graph_diego <- ggraph(net_diego, layout = "kk") +
geom_edge_link(aes(alpha = edge_centrality_betw)) + 
geom_node_point(aes(size = node_pagerank, 
                    colour = node_pagerank)) +
scale_color_continuous(guide = 'legend') +
theme_graph()

graph_diego

ggsave(here("Outputs", "graph_diego.png"))

# En este link hay varias buenas opciones de gráficos
# http://users.dimi.uniud.it/~massimo.franceschet/ns/syllabus/make/tidygraph/tidygraph.html
```

```{r}
#| label: net_nodes
#| echo: false
#| output: true

nodos <- net_diego |>
activate(nodes) |>
as_tibble()
```

```{r}
#| label: community_diego
#| echo: false
#| output: true

comunnity_diego <- ggraph(net_diego, layout = "kk") + 
  geom_edge_link(aes(alpha = stat(index)), show.legend = FALSE) + 
  geom_node_point(aes(colour = comunidad), size = 5) +
  geom_node_text(aes(label = siglas), repel = TRUE)
  theme_graph(foreground = 'steelblue', 
              fg_text_colour = 'white', 
              base_family = 'Helvetica')
 
comunnity_diego

```

[^redes-1]: Estrictamente existen múltiples medidas de centralidad. Aquí, para el caso de los nodos se calculó el *pagerank* que es similar al que utiliza google para ordenar las páginas en las búsquedas. En el caso de las relaciones se calculó una medida de centralidad basada en la intermediación (*betweenness*), que tiene en cuenta el número de caminos más cortos que pasan por una relación en un grafo.
